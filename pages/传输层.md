---
title: 传输层
---

## TCP/IP的三次握手和四次挥手
## 三次握手
## ![2021_05_30_image.png](https://cdn.logseq.com/%2F1e5b0e5f-d368-4a5d-86eb-09a690ee15d76e62d208-774c-4a6a-9935-88e6487e173d2021_05_30_image.png?Expires=4775961051&Signature=SCI1BaIfc8ubXi5oY-Wz5FZKAsIc7jTkJaYv2G35Yo9O0NPGMVNoliSAhxmv5SPr-D6MypUv6S2Ebokoq54zndJ92568j4~NQ~mBuNt50L9TG4n2X4rAOrC0uNX8B~veetes0Hkg54FpNQmzFpBGK8m8LgLZIWfot57-UMACqcl7mUYc5Z1p2YIe-5lie12OpDwUeMW8pwAv2QgGPzWWiHKp4YzghOBC~O6NSelOWZh1nppAc3Ki49Y9Aijw5y095ILplanXAN1UqJTpFMbH1fIWNbWOAz88W7xYxITjI8yEhvj8~uIFsAAZMf9ANX925JUH5RrDKRU94nvQYV6MZw__&Key-Pair-Id=APKAJE5CCD6X7MP6PTEA)
## 三次握手是 TCP 连接的建立过程。在握手之前，**主动打开连接的客户端结束 CLOSE 阶段**，**被动打开的服务器也结束 CLOSE 阶段**，并进入 LISTEN 阶段。随后进入三次握手阶段：
## ① 首先客户端向服务器发送一个 SYN 包，并等待服务器确认，其中：
**标志位为 SYN**，表示请求建立连接；
序号为 Seq = x（x 一般为 1）；
随后客户端进入 SYN-SENT 阶段。
## ② 服务器接收到客户端发来的 SYN 包后，对该包进行确认后结束 LISTEN 阶段，并返回一段 TCP 报文，其中：
标志位为 SYN 和 ACK，表示确认客户端的报文 Seq 序号有效，服务器能正常接收客户端发送的数据，并同意创建新连接；
序号为 Seq = y；
确认号为 Ack = x + 1，表示收到客户端的序号 Seq 并将其值加 1 作为自己确认号 Ack 的值，随后服务器端进入 SYN-RECV 阶段。
## ③ 客户端接收到发送的 SYN + ACK 包后，明确了从客户端到服务器的数据传输是正常的，从而结束 SYN-SENT 阶段。并返回最后一段报文。其中：
标志位为 ACK，表示确认收到服务器端同意连接的信号；
序号为 Seq = x + 1，表示收到服务器端的确认号 Ack，并将其值作为自己的序号值；
确认号为 Ack= y + 1，表示收到服务器端序号 seq，并将其值加 1 作为自己的确认号 Ack 的值。
随后客户端进入 ESTABLISHED。
## 四次挥手：
## ![2021_05_30_image.png](https://cdn.logseq.com/%2F1e5b0e5f-d368-4a5d-86eb-09a690ee15d7f8571b85-4db4-47f5-83d3-73f00908839e2021_05_30_image.png?Expires=4775962326&Signature=WYhpc7zLeY2iZKOuhzdLNmjZqIaoYpKXNU51MBnwprxCl8CsC5OpxBS8-8oi8My~DjUG~GS~SiAPKITPAA-vqMSQE9uYNnmVxLjxTi9mvFEhG6vVnRwifJJDRUSDldVGIh93WrGIHgwtVnlG0b8iO6pGNamWnkc--pr5QxwlwaKDTaHpu8T1-t21KUnSSQIcd76sot3Lu1X837zF8qcK6N0zNTP5v8A1OJE4Wtbgd7SjWpLdEpOTWpoUbFCJJgqqE~wsTqpJWJn-BuiEN8gysoSvJwfOzDNYw7hjI0XagdgsmsGSZ~v1Unz5vdn9YIMNIivNX4scl8wR0Otn~RpL5w__&Key-Pair-Id=APKAJE5CCD6X7MP6PTEA)
## ① 首先客户端向服务器发送一段 TCP 报文表明其想要释放 TCP 连接，其中：
标记位为 FIN，表示请求释放连接；
序号为 Seq = u；
随后客户端进入 FIN-WAIT-1 阶段，即半关闭阶段，并且停止向服务端发送通信数据。
② 服务器接收到客户端请求断开连接的 FIN 报文后，结束 ESTABLISHED 阶段，进入 CLOSE-WAIT 阶段并返回一段 TCP 报文，其中：
标记位为 ACK，表示接收到客户端释放连接的请求；
序号为 Seq = v；
确认号为 Ack = u + 1，表示是在收到客户端报文的基础上，将其序号值加 1 作为本段报文确认号 Ack 的值；
随后服务器开始准备释放服务器端到客户端方向上的连接。
客户端收到服务器发送过来的 TCP 报文后，确认服务器已经收到了客户端连接释放的请求，随后客户端结束 FIN-WAIT-1 阶段，进入 FIN-WAIT-2 阶段。
③ 服务器端在发出 ACK 确认报文后，服务器端会将遗留的待传数据传送给客户端，待传输完成后即经过 CLOSE-WAIT 阶段，便做好了释放服务器端到客户端的连接准备，再次向客户端发出一段 TCP 报文，其中：
标记位为 FIN 和 ACK，表示已经准备好释放连接了；
序号为 Seq = w；
确认号 Ack = u + 1，表示是在收到客户端报文的基础上，将其序号 Seq 的值加 1 作为本段报文确认号 Ack 的值。
随后服务器端结束 CLOSE-WAIT 阶段，进入 LAST-ACK 阶段。并且停止向客户端发送数据。
## ④ 客户端收到从服务器发来的 TCP 报文，确认了服务器已经做好释放连接的准备，于是结束 FIN-WAIT-2 阶段，进入 TIME-WAIT 阶段，并向服务器发送一段报文，其中：
标记位为 ACK，表示接收到服务器准备好释放连接的信号；
序号为 Seq= u + 1，表示是在已收到服务器报文的基础上，将其确认号 Ack 值作为本段序号的值；
确认号为 Ack= w + 1，表示是在收到了服务器报文的基础上，将其序号 Seq 的值作为本段报文确认号的值。
## 随后客户端开始在 TIME-WAIT 阶段等待 2 MSL。服务器端收到从客户端发出的 TCP 报文之后结束 LAST-ACK 阶段，进入 CLOSED 阶段。由此正式确认关闭服务器端到客户端方向上的连接。**客户端等待完 2 MSL 之后**，结束 TIME-WAIT 阶段，进入 CLOSED 阶段，由此完成「四次挥手」。
## **如果三次握手的时候每次握手信息对方没有收到会怎么样**
##
